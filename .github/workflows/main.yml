# ================================================
# ğŸš€ CI WORKFLOW â€” SUPER SPECIAL EDITION âœ¨
# ================================================
# This pipeline runs:
#  â€¢ Every 5 minutes â±ï¸
#  â€¢ On pushes to master ğŸ“¦
#  â€¢ On pull-requests targeting master ğŸ”
#  â€¢ On manual workflow_dispatch triggers ğŸ–±ï¸
# With concurrency so runs don't pile up. ğŸ›‘â¡ï¸ğŸŸ¢
# ================================================

name: CI

on:
  schedule:
    - cron: "*/5 * * * *"   # â±ï¸ Automated heartbeat build every 5 min
  push:
    branches:
      - master             # ğŸ“¦ Deploy on master push
  pull_request:
    branches:
      - master             # ğŸ” Validate incoming PRs
  workflow_dispatch:        # ğŸ–±ï¸ Allow manual triggering
    branches:

# ------------------------------------------------
# ğŸ§  Concurrency â€” ensures one run per branch
# Cancels older queued runs to save minutes
# ------------------------------------------------
concurrency:
  group: "ci-n"  # Unique per-branch group
  cancel-in-progress: true       # Preempt stale runs

jobs:
  build:
    env:
      PY_COLORS: "1"  # ğŸŒˆ Enable colorful terminal output

    strategy:
      fail-fast: false        # âŒ Don't collapse everything on one failure
      max-parallel: 1         # ğŸ§µ Single-threaded sequence
      matrix:
        os: [ubuntu-latest]   # ğŸ§ Linux only (for now)
        python-version: ["3.13"]  # ğŸ Latest Python

    runs-on: ${{ matrix.os }}

    steps:
    # ------------------------------------------------
    # ğŸ“¥ Checkout the repository
    # ------------------------------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    # ------------------------------------------------
    # ğŸ Install & configure Python
    # ------------------------------------------------
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    # ------------------------------------------------
    # ğŸŒ Locale setup â€” ensures unicode, dates, numbers
    # ------------------------------------------------
    - name: Set Locale
      run: |
        sudo apt-get install tzdata locales -y
        sudo locale-gen en_US.UTF-8
        sudo localectl set-locale LANG="en_US.UTF-8"
        export LANG="en_US.UTF-8"
        sudo update-locale
        locale -a
        locale
        locale -c -k LC_NUMERIC
        localectl status

    # ------------------------------------------------
    # âš¡ Cache pip dependencies (no requirements.txt needed!)
    # Keyed to workflow changes instead.
    # ------------------------------------------------
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.local
        key: ${{ runner.os }}-pip-${{ hashFiles('.github/workflows/**') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # ------------------------------------------------
    # ğŸ“¦ Install Python dependencies
    # ------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel
        pip install --upgrade seleniumbase pyautogui pymongo python-xlib

    # ------------------------------------------------
    # ğŸ§­ Chrome installation (Ubuntu latest)
    # ------------------------------------------------
    - name: Install Chrome
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt install -y google-chrome-stable || true

    # ------------------------------------------------
    # ğŸ›ï¸ Test console scripts â€” ensures SeleniumBase CLI works
    # ------------------------------------------------
    - name: Check the console scripts interface
      run: |
        seleniumbase
        sbase

    # ------------------------------------------------
    # ğŸï¸ Install the Chromedriver for SeleniumBase
    # ------------------------------------------------
    - name: Install chromedriver
      run: |
        seleniumbase install chromedriver

    # ------------------------------------------------
    # ğŸŒ Install & activate Cloudflare WARP VPN
    # ------------------------------------------------
    - name: Install Cloudflare WARP
      run: |
        sudo apt update
        sudo apt install -y curl
        curl https://pkg.cloudflareclient.com/pubkey.gpg \
          | sudo gpg --dearmor \
          -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg

        echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" \
          | sudo tee /etc/apt/sources.list.d/cloudflare-client.list

        sudo apt update
        sudo apt install -y cloudflare-warp

        # ğŸ“¡ Register & connect to WARP
        sudo warp-cli --accept-tos registration new
        sudo warp-cli --accept-tos connect
        sleep 5  # â³ Allow tunnel to stabilize
        sudo warp-cli --accept-tos status

    # ------------------------------------------------
    # ğŸ Run your Python script with debug, xvfb, chrome, screenshot
    # ------------------------------------------------
    - name: Run python truwi.py --debug
      run: |
        python truwi.py --debug --chrome --xvfb --screenshot

    # ------------------------------------------------
    # ğŸ“¤ Upload screenshots for diagnostics
    # ------------------------------------------------
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      with:
        name: seleniumbase-screenshots
        path: ./latest_logs/
